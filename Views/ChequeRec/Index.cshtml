@using elbanna.Helpers
@{
    int SCREEN_ID = (int)Screens.ChequeRec;
    bool canAdd = PermissionViewHelper.CanAdd(Context, SCREEN_ID);
    bool canEdit = PermissionViewHelper.CanEdit(Context, SCREEN_ID);
    bool canDelete = PermissionViewHelper.CanDelete(Context, SCREEN_ID);
    bool canReview = PermissionViewHelper.CanReview(Context) && canEdit;
    bool canPaid = PermissionViewHelper.CanReview(Context) && canEdit;
    Layout = null;
}
@model elbanna.ViewModels.ChequeRecVM

<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="utf-8" />
    <title>ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒØ§Øª</title>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            direction: rtl;
            background-color: #e6f5d0;
            color: black;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: #dff2c8;
            border-bottom: 2px solid #9bbb59;
            padding: 5px 10px;
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

            .topbar button {
                background: linear-gradient(to bottom, #ffffff 0%, #f3f9eb 100%);
                border: 1px solid #9bbb59;
                padding: 4px 12px;
                cursor: pointer;
                font-weight: bold;
                font-size: 13px;
                color: black;
                display: flex;
                align-items: center;
                gap: 5px;
                border-radius: 4px;
                transition: 0.2s;
            }

                .topbar button:hover {
                    background: #eaf7d9;
                    border-color: #6aa84f;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }

                .topbar button.btn-close {
                    color: #cc0000;
                }

                .topbar button.btn-save {
                    color: #2e7d32;
                }

                .topbar button.btn-new {
                    color: #1565c0;
                }

        .section-container {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .row-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            background: #f4fbe9;
            border: 1px dashed #9bbb59;
            border-radius: 4px;
        }

        .field-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-weight: bold;
            color: black;
            min-width: 60px;
        }

        input, select {
            border: 1px solid #9bbb59;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: Tahoma;
            font-size: 13px;
            color: black;
            background-color: white;
        }

        .table-container {
            flex: 1;
            overflow: auto;
            margin: 10px;
            border: 1px solid #9bbb59;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, #f2f2f2 0%, #e6e6e6 100%);
            border: 1px solid #ccc;
            padding: 8px;
            z-index: 10;
            font-weight: bold;
            color: black;
            text-align: center;
            border-bottom: 2px solid #9bbb59;
        }

        td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            color: black;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background-color: #fcfdfa;
        }

        tr:hover {
            background-color: #f1f8e9;
            cursor: pointer;
        }

        tr.selected {
            background-color: #2b78e4 !important;
            color: white !important;
        }

            tr.selected td {
                color: white !important;
            }
    </style>
</head>
<body>

    <div class="topbar">
        <button onclick="safeAction('add', newRow)" class="btn-new"><span>âœš</span> Ø¬Ø¯ÙŠØ¯</button>
        <button onclick="safeAction('add', save)" class="btn-save"><span>ğŸ’¾</span> Ø­ÙØ¸</button>
        <button onclick="loadList()"><span>ğŸ”</span> Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button onclick="paidClicked()"><span>ğŸ’°</span> ØªÙ… Ø§Ù„ØµØ±Ù</button>
        <button onclick="reviewClicked()"><span>âœ”</span> Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        <button onclick="safeAction('delete', deleteRow)" class="btn-close"><span>ğŸ—‘</span> Ø­Ø°Ù</button>
        <button onclick="safeAction('edit', updateRow)"><span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="location.href='/'" class="btn-close"><span>âœ–</span> ØºÙ„Ù‚</button>
    </div>

    <div class="section-container">
        <!-- Filters -->
        <div class="row-inputs">
            <div class="field-group">
                <label>Ù…Ù†</label>
                <input type="date" id="fromDate" value="@Model.DateFrom.ToString("yyyy-MM-dd")" />
            </div>
            <div class="field-group">
                <label>Ø¥Ù„Ù‰</label>
                <input type="date" id="toDate" value="@Model.DateTo.ToString("yyyy-MM-dd")" />
            </div>
            <div class="field-group">
                <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                <select id="filterCostCenter">
                    <option value="">-- Ø§Ø®ØªØ± --</option>
                    @foreach (var c in Model.CostCenters)
                    {
                        if (PermissionHelper.CanCostCenter(c.id, Context))
                        {
                            <option value="@c.id">@c.costCenter</option>
                        }
                    }
                </select>
            </div>
        </div>

        <!-- Form -->
        <div class="row-inputs">
            <input type="hidden" id="id" />
            <div class="field-group">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="processDate" />
            </div>
            <div class="field-group">
                <label>Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                <select id="dealerId">
                    <option value="">-- Ø§Ø®ØªØ± --</option>
                    @foreach (var d in Model.Dealers)
                    {
                        <option value="@d.id">@d.dealer</option>
                    }
                </select>
            </div>
            <div class="field-group">
                <label>Ø§Ù„Ø¨Ù†Ùƒ</label>
                <select id="bankId">
                    <option value="">-- Ø§Ø®ØªØ± --</option>
                    @foreach (var b in Model.Banks)
                    {
                        <option value="@b.id">@b.dealer</option>
                    }
                </select>
            </div>
        </div>

        <div class="row-inputs">
            <div class="field-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</label>
                <input type="text" id="chequeNo" />
            </div>
            <div class="field-group">
                <label>Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
                <input type="text" id="invoiceCode" />
            </div>
            <div class="field-group">
                <label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
                <input type="number" id="total" value="0" style="width:100px" />
            </div>
        </div>

        <div class="row-inputs">
            <div class="field-group">
                <input list="fromAccList" id="fromAcc" placeholder="Ù…Ù† Ø¹Ù‡Ø¯Ø©" />
                <datalist id="fromAccList">
                    @foreach (var a in Model.CreditAccounts)
                    {
                        <option value="@a.creditAcc"></option>
                    }
                </datalist>
            </div>
            <div class="field-group">
                <input list="toAccList" id="toAcc" placeholder="Ø¥Ù„Ù‰ Ø¹Ù‡Ø¯Ø©" />
                <datalist id="toAccList">
                    @foreach (var a in Model.CreditAccounts)
                    {
                        <option value="@a.creditAcc"></option>
                    }
                </datalist>
            </div>
            <div class="field-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <input type="text" id="notes" style="width:350px" />
            </div>
        </div>
    </div>

    <div class="table-container" id="tableContainer"></div>

    <script>
        const PERMS = {
            add: @PermissionHelper.Can((int)Screens.ChequeRec, "Add", Context).ToString().ToLower(),
            edit: @PermissionHelper.Can((int)Screens.ChequeRec, "Edit", Context).ToString().ToLower(),
            delete: @PermissionHelper.Can((int)Screens.ChequeRec, "Delete", Context).ToString().ToLower(),
            review: @((canReview) ? "true" : "false"),
            paid: @((canPaid) ? "true" : "false")
        };

        let selectedId = 0;

        function loadList() {
            if (!document.getElementById("filterCostCenter").value) { alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹"); return; }
            fetch('/ChequeRec/LoadList', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    DateFrom: document.getElementById("fromDate").value,
                    DateTo: document.getElementById("toDate").value,
                    CostCenterId: Number(document.getElementById("filterCostCenter").value)
                })
            }).then(r => r.text()).then(html => document.getElementById("tableContainer").innerHTML = html);
        }

        function selectRow(row) {
            document.querySelectorAll(".data-row").forEach(r => r.classList.remove("selected"));
            row.classList.add("selected");
            selectedId = row.dataset.id;
            document.getElementById("id").value = selectedId;
            document.getElementById("processDate").value = row.dataset.date || "";
            document.getElementById("toAcc").value = row.dataset.toacc || "";
            document.getElementById("fromAcc").value = row.dataset.fromacc || "";
            document.getElementById("invoiceCode").value = row.dataset.invoice || "";
            document.getElementById("notes").value = row.dataset.notes || "";
            document.getElementById("total").value = row.dataset.total || 0;
            document.getElementById("dealerId").value = row.dataset.dealerid || "";
            document.getElementById("bankId").value = row.dataset.bankid || "";
            document.getElementById("chequeNo").value = row.dataset.chequeno || "";
        }

        function newRow() {
            selectedId = 0; document.getElementById("id").value = "";
            document.querySelectorAll(".section-container input, .section-container select").forEach(x => { if(x.type !== 'date') x.value = ""; });
            document.getElementById("processDate").valueAsDate = new Date();
            document.getElementById("total").value = 0;
        }

        function save() { if (selectedId > 0) { alert("Ø§Ø³ØªØ®Ø¯Ù… ØªØ¹Ø¯ÙŠÙ„"); return; } send('/ChequeRec/Save'); }
        function updateRow() { if (!selectedId) return; send('/ChequeRec/Update'); }

        function send(url) {
            const cc = document.getElementById("filterCostCenter").value;
            if (!cc) { alert("Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨"); return; }
            const d = document.getElementById("dealerId");
            const b = document.getElementById("bankId");
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    Id: selectedId || 0,
                    ProcessDate: document.getElementById("processDate").value,
                    DealerId: d.value ? Number(d.value) : null,
                    BankId: b.value ? Number(b.value) : null,
                    CostCenterId: Number(cc),
                    ChequeNo: document.getElementById("chequeNo").value,
                    InvoiceCode: document.getElementById("invoiceCode").value,
                    Total: Number(document.getElementById("total").value),
                    Notes: document.getElementById("notes").value,
                    FromAcc: d.selectedIndex > 0 ? d.options[d.selectedIndex].text : "",
                    ToAcc: b.selectedIndex > 0 ? b.options[b.selectedIndex].text : ""
                })
            }).then(() => { alert("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­"); loadList(); newRow(); });
        }

        function deleteRow() {
            if (!selectedId) return; if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) return;
            fetch('/ChequeRec/Delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(Number(selectedId)) }).then(() => { loadList(); newRow(); });
        }



        // const CAN_REVIEW = @PermissionViewHelper.CanReview(Context).ToString().ToLower();

                 function reviewClicked(){
            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }
            reviewRow();
        }

        function paidClicked(){
            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }
            paidRow();
        }

                   function reviewRow() {

            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }

            if (!selectedId || selectedId === 0) {
                alert("Ø§Ø®ØªØ± ØµÙ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            const row = document.querySelector(`tr[data-id='${selectedId}']`);
            if (!row) {
                alert("Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„");
                return;
            }

            const isReviewed = row.dataset.reviewed === "true";
            if (isReviewed && !confirm("Ù‡Ù„ Ø£Ù†Øª Ø¹Ø§ÙˆØ² ØªØ­Ø°Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŸ")) return;

            fetch('/ChequeRec/ToggleReview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: selectedId })
            })
            .then(async r => {
                if (!r.ok) throw await r.text();
                return r.json();
            })
            .then(newState => {
                row.dataset.reviewed = newState ? "true" : "false";
                const chk = row.querySelector(".chk-reviewed");
                if (chk) chk.checked = newState;

                alert(newState ? "ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" : "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
            })
            .catch(e => alert(e));
        }


                       function paidRow() {

            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }

            if (!selectedId || selectedId === 0) {
                alert("Ø§Ø®ØªØ± ØµÙ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            const row = document.querySelector(`tr[data-id='${selectedId}']`);
            if (!row) {
                alert("Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„");
                return;
            }

            const isPaid = row.dataset.paid === "true";
            if (isPaid && !confirm("Ù‡Ù„ Ø£Ù†Øª Ø¹Ø§ÙˆØ² ØªÙ„ØºÙŠ Ø§Ù„ØµØ±ÙØŸ")) return;

            fetch('/ChequeRec/TogglePaid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: selectedId })
            })
            .then(async r => {
                if (!r.ok) throw await r.text();
                return r.json();
            })
            .then(newState => {
                row.dataset.paid = newState ? "true" : "false";
                const chk = row.querySelector(".chk-paid");
                if (chk) chk.checked = newState;

                alert(newState ? "ØªÙ… Ø§Ù„ØµØ±Ù" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ±Ù");
            })
            .catch(e => alert(e));
        }


        function safeAction(a, fn) { if (!PERMS[a]) { alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); return; } fn(); }
    </script>
</body>
</html>