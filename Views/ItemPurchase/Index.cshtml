@model YourProject.ViewModels.ItemPurchasePageVM
@{
    Layout = null;
}
@using elbanna.Helpers
@{
    int SCREEN_ID = (int)Screens.ItemPurchase;
    bool canReview = PermissionViewHelper.CanReview(Context) && PermissionHelper.Can(SCREEN_ID, "Edit", Context);
}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            direction: rtl;
            background-color: #e6f5d0;
            color: black;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Toolbar */
        .topbar {
            background: #dff2c8;
            border-bottom: 2px solid #9bbb59;
            padding: 5px 10px;
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

            .topbar button {
                background: linear-gradient(to bottom, #ffffff 0%, #f3f9eb 100%);
                border: 1px solid #9bbb59;
                padding: 4px 12px;
                cursor: pointer;
                font-weight: bold;
                font-size: 13px;
                color: black;
                display: flex;
                align-items: center;
                gap: 5px;
                border-radius: 4px;
                transition: 0.2s;
            }

                .topbar button:hover {
                    background: #eaf7d9;
                    border-color: #6aa84f;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }

                .topbar button:active {
                    transform: translateY(1px);
                }

                .topbar button.btn-close {
                    color: #cc0000;
                }

                .topbar button.btn-save {
                    color: #2e7d32;
                }

                .topbar button.btn-new {
                    color: #1565c0;
                }

        /* Settings Wrapper */
        .settings-wrapper {
            position: relative;
        }

        .settings-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border: 1px solid #9bbb59;
            min-width: 180px;
            z-index: 9999;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

            .settings-menu button {
                width: 100%;
                border: none;
                background: none;
                padding: 8px 12px;
                text-align: right;
                font-weight: bold;
                cursor: pointer;
                color: black;
                border-bottom: 1px solid #eee;
            }

                .settings-menu button:hover {
                    background: #f0f7e6;
                }

        .settings-wrapper:hover .settings-menu {
            display: block;
        }

        /* Entry & Filter Section */
        .section-container {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .row-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding: 8px;
            background: #f4fbe9;
            border: 1px dashed #9bbb59;
            border-radius: 4px;
        }

        .field-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-weight: bold;
            color: black;
            min-width: 60px;
            font-size: 12px;
        }

        input, select {
            border: 1px solid #9bbb59;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: Tahoma;
            font-size: 12px;
            color: black;
            background-color: white;
            height: 26px;
        }

            input:focus, select:focus {
                outline: none;
                border-color: #4a6125;
                box-shadow: 0 0 4px rgba(155, 187, 89, 0.3);
            }

            input[readonly] {
                background-color: #f9f9f9;
                font-weight: bold;
            }

        /* Table Grid */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            margin: 10px;
            border: 1px solid #9bbb59;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th {
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, #f2f2f2 0%, #e6e6e6 100%);
            border: 1px solid #ccc;
            padding: 8px;
            z-index: 10;
            font-weight: bold;
            color: black;
            text-align: center;
            border-bottom: 2px solid #9bbb59;
        }

        td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            color: black;
            white-space: nowrap;
            cursor: pointer;
        }

        tr:nth-child(even) {
            background-color: #fcfdfa;
        }

        tr:hover {
            background-color: #f1f8e9;
        }

        tr.active {
            background-color: #2b78e4 !important;
            color: white !important;
        }

            tr.active td {
                color: white !important;
            }

        tr.reviewed {
            background-color: #ffd9d9 !important;
        }
    </style>
</head>
<body>

    <script>
        const PERMS = {
            add: @PermissionHelper.Can((int)Screens.ItemPurchase, "Add", Context).ToString().ToLower(),
            edit: @PermissionHelper.Can((int)Screens.ItemPurchase, "Edit", Context).ToString().ToLower(),
            delete: @PermissionHelper.Can((int)Screens.ItemPurchase, "Delete", Context).ToString().ToLower(),
            review: @((canReview) ? "true" : "false"),
            print: @PermissionHelper.Can((int)Screens.ItemPurchase, "Print", Context).ToString().ToLower()
        };
        const CAN_REVIEW = @((canReview) ? "true" : "false");
    </script>

    <div class="topbar">
        <button onclick="safeAction('add', resetForm)" class="btn-new"><span>ğŸ“„</span> Ø¬Ø¯ÙŠØ¯</button>
        <button onclick="save()" class="btn-save"><span>ğŸ’¾</span> Ø­ÙØ¸</button>
        <button onclick="safeAction('edit', enterEditMode)"><span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="safeAction('delete', deleteRow)" class="btn-close"><span>ğŸ—‘ï¸</span> Ø­Ø°Ù</button>
        <div class="settings-wrapper">
            <button type="button"><span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <div class="settings-menu">
                <button type="button" onclick="openItems()">Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
                <button type="button" onclick="openCostEstimate()">Ù…Ù‚Ø§ÙŠØ³Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
            </div>
        </div>
        <button onclick="loadList()"><span>ğŸ“‹</span> Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button onclick="reviewClicked()"><span>ğŸ”</span> Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        <button onclick="closePage()" class="btn-close"><span>âŒ</span> ØºÙ„Ù‚</button>
    </div>

    <div class="section-container">
        <!-- Filters -->
        <div class="row-inputs">
            <div class="field-group"><label>Ù…Ù†</label><input type="date" id="dateFrom"></div>
            <div class="field-group"><label>Ø¥Ù„Ù‰</label><input type="date" id="dateTo"></div>
            <div class="field-group">
                <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                <select id="CostCenterId">
                    <option value="0">Ø§Ù„ÙƒÙ„</option>
                    @foreach (var c in Model.Filter.CostCenters)
                    {
                        <option value="@c.Value">@c.Text</option>
                    }
                </select>
            </div>
        </div>

        <hr style="border: none; border-top: 1px solid #9bbb59; margin: 0;" />

        <!-- Entry Form -->
        <div class="row-inputs">
            <input type="hidden" id="Id" />
            <div class="field-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="ProcessDate"></div>
            <div class="field-group">
                <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                <select id="DealerId" style="width: 180px;">
                    <option value=""></option>
                    @foreach (var d in Model.Filter.Dealers)
                    {
                        <option value="@d.Value">@d.Text</option>
                    }
                </select>
            </div>
            <div class="field-group">
                <label>Ø§Ù„ØµÙ†Ù</label>
                <select id="ItemId" style="width: 180px;">
                    <option value=""></option>
                    @foreach (var i in Model.Filter.Items)
                    {
                        <option value="@i.Value">@i.Text</option>
                    }
                </select>
            </div>
        </div>

        <div class="row-inputs">
            <div class="field-group"><label>Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="Building" list="BuildingsList" style="width: 100px;"></div>
            <div class="field-group"><label>Ø§Ù„Ø¯ÙˆØ±</label><input id="Floor" list="FloorsList" style="width: 100px;"></div>
            <div class="field-group"><label>Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="Unit" list="UnitsList" style="width: 100px;"></div>
            <datalist id="BuildingsList"></datalist><datalist id="FloorsList"></datalist><datalist id="UnitsList"></datalist>
        </div>

        <div class="row-inputs">
            <div class="field-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="Qty" style="width: 80px;"></div>
            <div class="field-group"><label>Ø³Ø¹Ø±</label><input type="number" id="UnitPrice" style="width: 80px;"></div>
            <div class="field-group"><label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input type="number" id="Total" readonly style="width: 100px;"></div>
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø§Ù„Ø¯ÙˆØ±</th>
                    <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th>Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                </tr>
            </thead>
            <tbody id="grid"></tbody>
        </table>
    </div>

    <script>
        let isEditMode = false;
        let fromShowListButton = false;

        function today() { return new Date().toISOString().substring(0, 10); }
        function setAllDatesToToday() { $('input[type="date"]').val(today()); }

        $(document).ready(function () {
            setAllDatesToToday();
            $('#grid').html('');
        });

        function loadList() {
            const df = $('#dateFrom').val(), dt = $('#dateTo').val(), ci = $('#CostCenterId').val();
            if (!df || !dt) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®'); return; }
            $.get('/ItemPurchase/GetList', { DateFrom: df, DateTo: dt, CostCenterId: ci }, function (data) {
                let html = '';
                if (!data || data.length === 0) { $('#grid').html(''); if (fromShowListButton) alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); fromShowListButton = false; return; }
                data.forEach(x => {
                    html += `<tr data-id="${x.id}" class="${x.isReviewed ? 'reviewed' : ''}"><td>${x.unit ?? ''}</td><td>${x.floor ?? ''}</td><td>${x.building ?? ''}</td><td>${x.item ?? ''}</td><td>${x.unitPrice ?? ''}</td><td>${x.processDate ? x.processDate.substring(0,10) : ''}</td><td>${x.costCenter ?? ''}</td><td>${x.qty ?? ''}</td><td style="font-weight:bold">${x.total ?? ''}</td><td>${x.userName ?? ''}</td><td>${x.dealer ?? ''}</td><td><input type="checkbox" ${x.isReviewed ? 'checked' : ''} disabled></td></tr>`;
                });
                $('#grid').html(html);
                fromShowListButton = false;
            });
        }

        $(document).on('click', '#grid tr', function () {
            $('#grid tr').removeClass('active'); $(this).addClass('active');
            const tds = $(this).children('td'), id = $(this).data('id');
            $('#Id').val(id);
            $('#Unit').val(tds.eq(0).text()); $('#Floor').val(tds.eq(1).text()); $('#Building').val(tds.eq(2).text());
            $('#ItemId option').filter(function () { return $(this).text() === tds.eq(3).text(); }).prop('selected', true);
            $('#UnitPrice').val(tds.eq(4).text()); $('#ProcessDate').val(tds.eq(5).text());
            $('#CostCenterId option').filter(function () { return $(this).text() === tds.eq(6).text(); }).prop('selected', true);
            $('#Qty').val(tds.eq(7).text()); $('#Total').val(tds.eq(8).text());
            $('#DealerId option').filter(function () { return $(this).text() === tds.eq(10).text(); }).prop('selected', true);
        });

        function save() {
            if (!isEditMode && !PERMS.add) return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
            if (isEditMode && !PERMS.edit) return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
            const costId = $('#CostCenterId').val();
            if (!costId || costId === '0') return alert('Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ ØµØ­ÙŠØ­');
            const url = isEditMode ? '/ItemPurchase/Edit' : '/ItemPurchase/Create';
            $.post(url, { Id: $('#Id').val(), ProcessDate: $('#ProcessDate').val(), CostCenterId: costId, CostCenter: $('#CostCenterId option:selected').text(), DealerId: $('#DealerId').val(), ItemId: $('#ItemId').val(), Building: $('#Building').val(), Floor: $('#Floor').val(), Unit: $('#Unit').val(), Qty: $('#Qty').val(), UnitPrice: $('#UnitPrice').val() })
            .then(() => { alert('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­'); loadList(); resetForm(); });
        }

        function deleteRow() {
            const row = $('#grid tr.active'); if (row.length === 0) return alert('Ø§Ø®ØªØ± ØµÙ');
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
            $.post('/ItemPurchase/Delete', { id: row.data('id') }).then(() => { row.remove(); resetForm(); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); });
        }

        function resetForm() { isEditMode = false; $('#Id').val(''); $('#DealerId,#ItemId,#Building,#Floor,#Unit,#Qty,#UnitPrice').val(''); $('#Total').val(0); setAllDatesToToday(); }
        $('#Qty,#UnitPrice').on('input', function () { $('#Total').val((parseFloat($('#Qty').val()) || 0) * (parseFloat($('#UnitPrice').val()) || 0)); });

         // const CAN_REVIEW = @((canReview) ? "true" : "false");

               function reviewClicked(){
            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }
            toggleReviewBtn();
        }

                 function toggleReviewBtn() {

            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }

            const row = $('#grid tr.active');
            if (row.length === 0) {
                alert('Ø§Ø®ØªØ± ØµÙ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const id = row.data('id');
            const chk = row.find('.chk-review');

            if (!id) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ');
                return;
            }

            const isReviewed = row.hasClass('reviewed');
            if (isReviewed && !confirm('Ø§Ù„ØµÙ Ù…ØªØ±Ø§Ø¬Ø¹ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŸ'))
                return;

            $.post('/ItemPurchase/ToggleReview', { id })
                .done(function (res) {
                    if (res.isReviewed === true) {
                        row.addClass('reviewed');
                        chk.prop('checked', true);
                        alert('ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        row.removeClass('reviewed');
                        chk.prop('checked', false);
                        alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
                    }
                })
                .fail(function (xhr) {
                    alert(xhr.responseText || 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
                });
        }



        function enterEditMode() { if ($('#grid tr.active').length === 0) return alert('Ø§Ø®ØªØ± ØµÙ'); isEditMode = true; alert('ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ¹Ù„'); }
        function openItems() { window.location.href = "/Item/Index"; }
        function openCostEstimate() { window.location.href = "/Inspect/Index"; }
        function closePage() { window.location.href = '/Home/Index'; }
        function safeAction(a, fn) { if (!PERMS[a]) return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); fn(); }
    </script>
</body>
</html>