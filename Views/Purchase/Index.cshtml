@using elbanna.Models
@using elbanna.Helpers
@{
    bool canAdd = PermissionHelper.Can((int)Screens.Purchase, "Add", Context);
    bool canEdit = PermissionHelper.Can((int)Screens.Purchase, "Edit", Context);
    bool canDelete = PermissionHelper.Can((int)Screens.Purchase, "Delete", Context);
    bool canPrint = PermissionHelper.Can((int)Screens.Purchase, "Print", Context);
    bool canReview = PermissionViewHelper.CanReview(Context);
    Layout = null;
}
@model elbanna.Models.ViewModels.PurchaseVM

<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="utf-8" />
    <title>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            direction: rtl;
            background-color: #e6f5d0;
            color: black;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: #dff2c8;
            border-bottom: 2px solid #9bbb59;
            padding: 5px 10px;
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

            .topbar button {
                background: linear-gradient(to bottom, #ffffff 0%, #f3f9eb 100%);
                border: 1px solid #9bbb59;
                padding: 4px 12px;
                cursor: pointer;
                font-weight: bold;
                font-size: 13px;
                color: black;
                display: flex;
                align-items: center;
                gap: 5px;
                border-radius: 4px;
                transition: 0.2s;
            }

                .topbar button:hover {
                    background: #eaf7d9;
                    border-color: #6aa84f;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }

                .topbar button.btn-close {
                    color: #cc0000;
                }

                .topbar button.btn-save {
                    color: #2e7d32;
                }

                .topbar button.btn-new {
                    color: #1565c0;
                }

        .section-container {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .row-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            background: #f4fbe9;
            border: 1px dashed #9bbb59;
            border-radius: 4px;
        }

        .field-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-weight: bold;
            color: black;
            min-width: 60px;
        }

        input, select {
            border: 1px solid #9bbb59;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: Tahoma;
            font-size: 13px;
            color: black;
            background-color: white;
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
            margin: 10px;
            border: 1px solid #9bbb59;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1500px;
        }

        th {
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, #f2f2f2 0%, #e6e6e6 100%);
            border: 1px solid #ccc;
            padding: 8px;
            z-index: 10;
            font-weight: bold;
            color: black;
            text-align: center;
            border-bottom: 2px solid #9bbb59;
        }

        td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            color: black;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background-color: #fcfdfa;
        }

        tr:hover {
            background-color: #f1f8e9;
            cursor: pointer;
        }

        tr.selected-row {
            background-color: #2b78e4 !important;
            color: white !important;
        }

            tr.selected-row td {
                color: white !important;
            }

        .search-input {
            width: 100%;
            box-sizing: border-box;
            font-size: 11px;
        }
    </style>
</head>
<body>

    <div class="topbar">
        <button type="button" onclick="safeAction('add', newRow)" class="btn-new"><span>ğŸ“„</span> Ø¬Ø¯ÙŠØ¯</button>
        <button type="button" onclick="safeAction('add', save)" class="btn-save"><span>ğŸ’¾</span> Ø­ÙØ¸</button>
        <button type="button" onclick="safeAction('edit', editSelected)"><span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„</button>
        <button type="button" onclick="showList()"><span>ğŸ“‹</span> Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button type="button" onclick="reviewClicked()">
            <span>ğŸ”</span> Ù…Ø±Ø§Ø¬Ø¹Ø©
        </button>
        <button type="button" onclick="safeAction('delete', deleteSelected)" class="btn-close"><span>ğŸ—‘ï¸</span> Ø­Ø°Ù</button>
        <button type="button" onclick="safeAction('print', exportExcel)"><span>ğŸ“Š</span> Excel</button>
        <button type="button" onclick="closePage()" class="btn-close"><span>âŒ</span> ØºÙ„Ù‚</button>
    </div>

    <input type="hidden" id="editId" value="0" />

    <div class="section-container">
        <!-- Filters -->
        <div class="row-inputs">
            <div class="field-group">
                <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                <select id="costcenterId">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ --</option>
                    <option value="0">Ø§Ù„ÙƒÙ„</option>
                    @foreach (var c in Model.CostCenters)
                    {
                        <option value="@c.id">@c.costCenter</option>
                    }
                </select>
            </div>
            <div class="field-group">
                <label>Ù…Ù†</label>
                <input type="date" id="fromDate" value="@DateTime.Today.AddDays(-7).ToString("yyyy-MM-dd")" />
            </div>
            <div class="field-group">
                <label>Ø¥Ù„Ù‰</label>
                <input type="date" id="toDate" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
            </div>
        </div>

        <!-- Entry Form -->
        <div class="row-inputs">
            <div class="field-group">
                <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                <select id="dealerId">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯ --</option>
                    @foreach (var d in Model.Dealers)
                    {
                        <option value="@d.id">@d.Name</option>
                    }
                </select>
            </div>
            <div class="field-group">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="processDate" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
            </div>
            <div class="field-group">
                <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                <input type="text" id="invoiceNo" />
            </div>
        </div>

        <div class="row-inputs">
            <div class="field-group">
                <label>Ø§Ù„ØµÙ†Ù</label>
                <select id="itemId">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option>
                    @foreach (var i in Model.Items)
                    {
                        <option value="@i.Id">@i.Name</option>
                    }
                </select>
            </div>
            <div class="field-group">
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input type="number" id="qty" value="0" step="0.01" style="width:80px" />
            </div>
            <div class="field-group">
                <label>Ø³Ø¹Ø±</label>
                <input type="number" id="unitPrice" value="0" step="0.01" style="width:80px" />
            </div>
            <div class="field-group">
                <label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
                <input type="number" id="total" value="0" readonly style="width:100px; font-weight:bold" />
            </div>
        </div>
    </div>

    <div id="tableWrapper" class="table-wrapper" style="display:none;">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                </tr>
                <tr class="search-row">
                    <th><input type="text" class="search-input" data-col="0" /></th>
                    <th><input type="text" class="search-input" data-col="1" /></th>
                    <th><input type="text" class="search-input" data-col="2" /></th>
                    <th><input type="text" class="search-input" data-col="3" /></th>
                    <th><input type="text" class="search-input" data-col="4" /></th>
                    <th><input type="date" class="search-input" data-col="5" /></th>
                    <th><input type="text" class="search-input" data-col="6" /></th>
                    <th><input type="text" class="search-input" data-col="7" /></th>
                    <th></th>
                    <th><input type="text" class="search-input" data-col="9" /></th>
                </tr>
            </thead>
            <tbody id="purchaseBody"></tbody>
        </table>
    </div>

    <script>
        const PERMS = {
            add: @canAdd.ToString().ToLower(),
            edit: @canEdit.ToString().ToLower(),
            del: @canDelete.ToString().ToLower(),
            review: @canReview.ToString().ToLower(),
            print: @canPrint.ToString().ToLower()
        };

        let selectedRowId = null;
        let selectedTr = null;
        let currentTableData = [];

        function calcTotal() {
            const q = Number(document.getElementById("qty").value) || 0;
            const p = Number(document.getElementById("unitPrice").value) || 0;
            document.getElementById("total").value = (q * p).toFixed(2);
        }
        document.getElementById("qty").addEventListener("input", calcTotal);
        document.getElementById("unitPrice").addEventListener("input", calcTotal);

        function loadTable(from, to, ccId) {
            const tbody = document.getElementById("purchaseBody");
            tbody.innerHTML = "<tr><td colspan='10'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";

            fetch(`/Purchase/GetList?fromDate=${from}&toDate=${to}&costcenterId=${ccId}`)
                .then(r => r.json())
                .then(data => {
                    currentTableData = data;
                    tbody.innerHTML = "";
                    if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='10'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>"; return; }

                    data.forEach(d => {
                        const tr = document.createElement("tr");
                        tr.dataset.id = d.id;
                        tr.dataset.reviewed = d.isReviewed ? "true" : "false";
                        tr.innerHTML = `
                            <td>${d.dealer ?? ''}</td>
                            <td>${d.insertUser ?? ''}</td>
                            <td>${d.total ?? 0}</td>
                            <td>${d.qty ?? 0}</td>
                            <td>${d.costcenter ?? ''}</td>
                            <td>${d.processDate ? d.processDate.substring(0, 10) : ''}</td>
                            <td>${d.unitPrice ?? 0}</td>
                            <td>${d.item ?? ''}</td>
                            <td><input type="checkbox" disabled ${d.isReviewed ? "checked" : ""}></td>
                            <td>${d.invoiceNo ?? ''}</td>
                        `;
                        tr.onclick = () => selectRow(tr, d);
                        tbody.appendChild(tr);
                    });
                });
        }

        function selectRow(tr, d) {
            document.querySelectorAll("#purchaseBody tr").forEach(r => r.classList.remove("selected-row"));
            tr.classList.add("selected-row");
            selectedTr = tr;
            selectedRowId = d.id;
            document.getElementById("editId").value = d.id;

            document.getElementById("qty").value = d.qty || 0;
            document.getElementById("unitPrice").value = d.unitPrice || 0;
            document.getElementById("total").value = d.total || 0;
            document.getElementById("processDate").value = d.processDate ? d.processDate.substring(0, 10) : "";
            document.getElementById("invoiceNo").value = d.invoiceNo || "";
            document.getElementById("itemId").value = d.itemId || "";
            setSelectByText("dealerId", d.dealer);
            setSelectByText("costcenterId", d.costcenter);
        }

        function setSelectByText(id, text) {
            const s = document.getElementById(id);
            for (let i = 0; i < s.options.length; i++) {
                if (s.options[i].text.trim() === text?.trim()) { s.selectedIndex = i; return; }
            }
        }

        function save() {
            if (selectedRowId) { alert("Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± ØªØ¹Ø¯ÙŠÙ„"); return; }
            if (!PERMS.add) { alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); return; }
            const model = getModel(0);
            if (!model.CostCenterId || !model.DealerId) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
            if (!confirm("Ø­ÙØ¸ØŸ")) return;

            fetch("/Purchase/Save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(model)
            }).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); newRow(); showList(); });
        }

        function editSelected() {
            if (!selectedRowId) { alert("Ø§Ø®ØªØ± ØµÙ"); return; }
            if (!PERMS.edit) { alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); return; }
            if (selectedTr.dataset.reviewed === "true") { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±Ø§Ø¬Ø¹"); return; }
            const model = getModel(selectedRowId);
            fetch("/Purchase/Save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(model)
            }).then(() => { alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"); newRow(); showList(); });
        }

        function getModel(id) {
            return {
                Id: id,
                Date: document.getElementById("processDate").value,
                CostCenterId: Number(document.getElementById("costcenterId").value),
                DealerId: Number(document.getElementById("dealerId").value),
                ItemId: Number(document.getElementById("itemId").value),
                Qty: Number(document.getElementById("qty").value),
                UnitPrice: Number(document.getElementById("unitPrice").value),
                InvoiceNo: document.getElementById("invoiceNo").value
            };
        }

        function showList() {
            const f = document.getElementById("fromDate").value;
            const t = document.getElementById("toDate").value;
            const c = document.getElementById("costcenterId").value;
            if (!f || !t) { alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"); return; }
            document.getElementById("tableWrapper").style.display = "block";
            loadTable(f, t, c);
        }

        function newRow() {
            selectedRowId = null; selectedTr = null;
            document.getElementById("editId").value = 0;
            document.querySelectorAll("#purchaseBody tr").forEach(r => r.classList.remove("selected-row"));
            document.getElementById("qty").value = 0;
            document.getElementById("unitPrice").value = 0;
            document.getElementById("total").value = 0;
            document.getElementById("invoiceNo").value = "";
        }

        function deleteSelected() {
            if (!selectedRowId) return;
            if (selectedTr.dataset.reviewed === "true") { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…Ø±Ø§Ø¬Ø¹"); return; }
            if (!confirm("Ø­Ø°ÙØŸ")) return;
            fetch(`/Purchase/Delete?id=${selectedRowId}`, { method: "POST" }).then(() => { showList(); newRow(); });
        }


                      const CAN_REVIEW = @PermissionViewHelper.CanReview(Context).ToString().ToLower();

        function reviewClicked() {
            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }
            toggleReview(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† safeAction
        }





                       function toggleReview() {
            if (!CAN_REVIEW) {
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
                return;
            }

            if (!selectedRowId) return;

            const isR = selectedTr.dataset.reviewed === "true";
            if (!confirm(isR ? "Ø¥Ù„ØºØ§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø©ØŸ" : "Ù…Ø±Ø§Ø¬Ø¹Ø©ØŸ")) return;

            fetch("/Purchase/ToggleReview", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: selectedRowId, review: !isR })
            })
            .then(r => {
                if (!r.ok) throw "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©";
                return r.text();
            })
            .then(() => showList())
            .catch(err => alert(err));
        }



        function closePage() { window.location.href = "/Home/Index"; }
        function safeAction(a, fn) { if (!PERMS[a]) { alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); return; } fn(); }

        function exportExcel() {
            const table = document.querySelector("#tableWrapper table");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "Purchases.xlsx");
        }
    </script>
</body>
</html>